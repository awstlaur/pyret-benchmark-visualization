<html>
  <head>
    <!-- load jQuery + plugins first -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="js/papaparse.min.js"></script>

    <!-- bootstrap, because I like over-doing things -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- HighCharts library (free for non-profit use) -->
    <script src="js/highcharts/highcharts.js"></script>
    <script src="js/highcharts/modules/exporting.js"></script>

    <!-- our code & styles-->
    <script src="visualize.js"></script>
    <link rel="stylesheet" href="visualize.css">
  </head>
  <body>
    
    <span id="nav-links" style="display: none;">
      <ul class="nav nav-pills">
        <li><a id="back-nav" href="#">Back</a></li>
        <li><a id="forward-nav" href="#">Forward</a></li>
        <li><a id="toggle-nav" href="#">Toggle</a></li>
        <li><a id="jenkins-nav" target="_blank" href="#">Jenkins Summary</a></li>
        <li><a id="csv-download" href="#">CSV File</a></li>
      </ul>          
    </span>
    <div id="container" style="overflow: hidden;"></div>
    <form id="choose-build" style="display: none;">
      Build Number: (310 or higher)
      <input type="text" name="build" min="1">
      Normalized?
      <input type="checkbox" name="normalized">
    </form>

    <script>
      // http://stackoverflow.com/a/2880929
      (window.onpopstate = function () {
          var match,
              pl     = /\+/g,  // Regex for replacing addition symbol with a space
              search = /([^&=]+)=?([^&]*)/g,
              decode = function (s) { 
                return decodeURIComponent(s.replace(pl, " ")); 
              },
              query  = window.location.search.substring(1);

          urlParams = {};
          while (match = search.exec(query))
             urlParams[decode(match[1])] = decode(match[2]);
      })();

      if (urlParams.build) {
        var build = parseInt(urlParams.build);
        var normalized = urlParams.normalized === 'on';

        var promise = visualize(build, normalized);

        promise.fail(function () {
          $('#choose-build').toggle(true);
          alertError(build);
        });

        promise.done(function () {
          var previous = (build - 1);
          var next = (build + 1);

          $('#nav-links').toggle(true);

          $('#back-nav').attr('href', '?build=' + previous 
          + '&normalized=' + (normalized ? 'on' : 'off'));

          $('#back-nav').html(previous);

          $('#forward-nav').attr('href', '?build=' + next
          + '&normalized=' + (normalized ? 'on' : 'off'));

          $('#forward-nav').html(next);

          $('#toggle-nav').attr('href', '?build=' + build
          + '&normalized=' + (normalized ? 'off' : 'on'));

          $('#toggle-nav').html(normalized ? 
            'Toggle (Raw Hertz)' : 'Toggle (Normalized)');  
        })

        
      } else {
        $('#choose-build').toggle(true);
      }

      


      // .click(function (e) {
      //   build = build - 1;
      //   visualize(build, normalized).fail(function () {
      //     alertError(build);
      //     build = build + 1;
      //   });
      // });

      // .click(function (e) {
      //   build = build + 1;
      //   visualize(build, normalized).fail(function () {
      //     alertError(build);
      //     build = build - 1;
      //   });
      // });
    </script>
  </body>
</html>
