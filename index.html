<html>
  <head>
    <!-- load jQuery + plugins first -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="js/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script type="text/javascript" src="js/jquery.rss.js"></script>

    <!-- bootstrap, because I like over-doing things -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- HighCharts library (free for non-profit use) -->
    <script src="js/highcharts/highcharts.js"></script>
    <script src="js/highcharts/modules/exporting.js"></script>

    <!-- our code & styles-->
    <script src="visualize.js"></script>
    <link rel="stylesheet" href="visualize.css">
  </head>
  <body>
    
    <span id="nav-links" style="display: none;">
      <ul class="nav nav-pills">
        <li><a id="home-nav" href=".">Home</a></li>
        <li><a id="back-nav" href="#">Back</a></li>
        <li><a id="forward-nav" href="#">Forward</a></li>
        <li><a id="toggle-nav" href="#">Toggle</a></li>
        <li><a id="sort-nav" href="#">Sort</a></li>
        <li><a id="jenkins-nav" target="_blank" href="#">Jenkins Summary</a></li>
        <li><a id="csv-download" href="#">CSV File</a></li>
      </ul>          
    </span>

    <div id="container" style="overflow: hidden;"></div>

    <form role="form" id="choose-build" style="display: none;">
      <h3>Option 1: Select Jenkins Build Number</h3>
      <div class="form-group">
        <label for="build-number">Build number:</label><br />
        (310 or higher; or specify range (e.g. '2040:2050'))<br />
        <input type="text" name="build" min="310" autofocus id="build-number">
      </div>
      <div class="checkbox">
        <label><input type="checkbox" name="normalized"> Normalize?</label>
      </div>
      <div class="checkbox">
        <label><input type="checkbox" name="sort"> Sort?</label>
      </div>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>

    <form role="form" id="choose-file" style="display: none;">
      <h3>Option 2: Use Local File</h3>
      (Everything happens client-side.)
        <input type="file" name = "filename"/>
    </form>

    <div id="rss-container" style="display:none;">
      <h3>Here's the latest from Jenkins</h3>
      <h6>Note: this site updates at midnight. It may not have the latest builds.</h6>
      <div id="rss-feeds"></div>  
    </div>
    
    
    
    <script>
      // http://stackoverflow.com/a/2880929
      (window.onpopstate = function () {
          var match,
              pl     = /\+/g,  // Regex for replacing addition symbol with a space
              search = /([^&=]+)=?([^&]*)/g,
              decode = function (s) { 
                return decodeURIComponent(s.replace(pl, " ")); 
              },
              query  = window.location.search.substring(1);

          urlParams = {};
          while (match = search.exec(query))
             urlParams[decode(match[1])] = decode(match[2]);
      })();

      if (urlParams.build) {
        var build = urlParams.build;
        if (build.endsWith('/')) {
          build = build.slice(0, build.length - 1);
        }

        var normalized = urlParams.normalized 
          ? urlParams.normalized.slice(0,2) === 'on'
          : false;

        var sort = urlParams.sort 
          ? urlParams.sort.slice(0,2) === 'on'
          : false;

        var promise = visualize(build, normalized, sort);

        promise.fail(function () {
          showIndexPage();
          alertError(build);
        });

        promise.done(function () {
          var previous = (build - 1);
          var next = (build + 1);

          $('#nav-links').toggle(true);

          $('#back-nav').attr('href', '?build=' + previous 
          + '&normalized=' + (normalized ? 'on' : 'off')
          + '&sort=' + (sort ? 'on' : 'off'));

          $('#back-nav').html(previous);

          $('#forward-nav').attr('href', '?build=' + next
          + '&normalized=' + (normalized ? 'on' : 'off')
          + '&sort=' + (sort ? 'on' : 'off'));

          $('#forward-nav').html(next);

          $('#toggle-nav').attr('href', '?build=' + build
          + '&normalized=' + (normalized ? 'off' : 'on')
          + '&sort=' + (sort ? 'on' : 'off'));

          $('#toggle-nav').html(normalized ? 
            'Toggle (Raw Hertz)' : 'Toggle (Normalized)');

          $('#sort-nav').attr('href', '?build=' + build
          + '&normalized=' + (normalized ? 'on' : 'off')
          + '&sort=' + (sort ? 'off' : 'on'));

          $('#sort-nav').html(sort ? 
            'Sort (Alpha)' : 'Sort (File Size)');  


        })

        
      } else {
// htmlgoodies.com/beyond/javascript/read-text-files-using-the-javascript-filereader.html
        function readSingleFile(evt) {
            //Retrieve the first (and only!) File from the FileList object
            var f = evt.target.files[0]; 

            if (f) {
              var r = new FileReader();
              r.onload = function(e) { 
                var contents = e.target.result;
                if (f.type !== 'text/csv') {
                  alert('Please choose a csv file!');
                } else {
                  visualizeFromSource(contents, f.name);
                }
              }
              r.readAsText(f);
            } else { 
              alert("Failed to load file");
            }
          }

          document.getElementById('choose-file').addEventListener('change', readSingleFile, false);

        showIndexPage();
      }
    </script>
  </body>
</html>
